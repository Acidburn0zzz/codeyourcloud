<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Using the Google Drive realtime API</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="../about/flat/js/jquery-1.8.3.min.js"></script>

    <!-- Loading Bootstrap -->
    <link href="../about/flat/bootstrap/css/bootstrap.css" rel="stylesheet">

    <!-- Loading Flat UI -->
    <link href="../about/flat/css/flat-ui.css" rel="stylesheet">

    <link rel="shortcut icon" href="../favicon.ico">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements. All other JS at the end of file. -->
    <!--[if lt IE 9]>
      <script src="../about/flat/js/html5shiv.js"></script>
      <script src="../about/flat/js/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="lesson.css"/>
    <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js"></script>
    <link rel='stylesheet' type='text/css' href='../lib/Font/css/font-awesome.min.css'>
  </head>
  
  <body>
    <!-- /.container -->
    
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
	  <div class="container-fluid">
	    <!-- Brand and toggle get grouped for better mobile display -->
	    <div class="navbar-header">
	      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
	        <span class="sr-only">Toggle navigation</span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	      </button>
	      <a class="navbar-brand" href="https://codeyourcloud.com">Code Your Cloud</a>
	    </div>
	
	    <!-- Collect the nav links, forms, and other content for toggling -->
	    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
	      <ul class="nav navbar-nav">
	      	<li><a href="https://codeyourcloud.com/about">About</a></li>
	        <li><a href="https://codeyourcloud.com/lessons"><i class="fa fa-graduation-cap"></i> Lessons</a></li>
	        <div class="navbar-form navbar-left" role="search">
        		<div class="form-group">
          			<input type="text" class="form-control" placeholder="Search" id="search_input">
        		</div>
        		<button class="btn btn-default" onclick="search()"><i class="fa fa-search"></i></button>
      		</div>
      		</ul>
      	<ul class="nav navbar-nav navbar-right">
      		<li><a href="https://codeyourcloud.com/help"><i class="fa fa-life-ring"></i> Help</a></li>
      		<li><a href="https://codeyourcloud.com/about#contact"><i class="fa fa-comment-o"></i> Contact us</a></li>
      		<li id="github"><a href="https://github.com/mkaminsky11/codeyourcloud"><i class="fa fa-github-square"></i> Github</a></li>
	      </ul>
	    </div><!-- /.navbar-collapse -->
	  </div><!-- /.container-fluid -->
	</nav>
	
	
    <div id="main">
    	<h1>Using the Google Drive realtime API</h1>
    	<p>The Google Drive realtime API is an extremely powerful tool that allows for collaboration on documents stored with Google Drive. All realtime variables and values are independent of the actual content of the file, so if you want to collaboratively <b>edit</b> the file, you will need to sync them.</p>
    	
    	<h6>1. Gather your materials</h6>
    	<p>This is simple. Just get the Google javascript api.</p>
<pre class="prettyprint">
&lt;script src="https://codeyourcloud.com/client.js"&gt;&lt;script&gt;
</pre>
		<br/>
		
		
		<h6>2. Load the API</h6>
		<p><code>CLIENT_ID</code> is the identifier for your project. <code>SCOPES</code> is the array of scopes for authorization. <code>file_id</code> is the id of the file you are trying to read. It is unique to every file.</p>

<pre class="prettyprint">
var CLIENT_ID = "something";
var SCOPES = ['https://www.googleapis.com/auth/drive.install','https://www.googleapis.com/auth/drive'];
var file_id = "0ByWSHHBN-zyoRVN6UVlkYlp2dGM";

function loadDrive(){
	gapi.auth.authorize({'client_id': CLIENT_ID, 'scope': SCOPES.join(' '), 'immediate': true},handleAuth);
}
function handleAuth(authResult){
	if (authResult) {
		//logged in
		loadClient();
		
	} 
}

function loadClient() {
	gapi.load("auth:client,drive-realtime,drive-share", load_real);
}

function load_real(){
	init();
}
function init(){
	//to be defined
}
</pre>
	
	<p>Next, we load the realtime API itself, and its callbacks.</p>
<pre class="prettyprint">
function init(){
	gapi.drive.realtime.load(file_id, loaded_realtime, init_realtime, errorFn);
}

function loaded_realtime(doc){
	
}

function init_realtime(model){

}

function errorFn(error){

}
</pre>
	<p>There is an important difference between <code>init_realtime</code> and <code>loaded_realtime</code>. <code>init_realtime</code> is only called the first time the realtime API accesses a file. This is used to initialize the values. <code>loaded_realtime</code> is called every time the file is accessed, including after <code>init_realtime</code> is loaded.</p>
	
	<h6>3. Manipulate the data</h6>
	<p>The <code>doc</code> passed in <code>loaded_realtime</code> is the document itself. <code>model</code> in <code>init_realtime</code> is obtained by using <code>doc.getModel()</code>. Note that any changes to <code>model</code> will impact <code>doc</code> and vice versa. In order to keep the document easily on hand, we should store it with a global variable.</p>
	
<pre class="prettyprint">
var realtime_doc;
function loaded_realtime(doc){
	realtime_doc = doc;
}
</pre>	
	<p>Using <code>doc</code>, you can change the realtime values associated with the file. However, this cannot be done until the values are initialized the first time the file is loaded. For our example, we will be using 2 values: text and title. These, however, cannot be regular strings. They must be collaborative strings.</p>
	
<pre class="prettyprint">
function init_realtime(model){
	model.getRoot().set("text", model.createString("default text"));
	//						constructor for collaborative string
	model.getRoot().set("text", model.createString("default title"));
}
</pre>	

	<p>Once the values are initialized, they can be changed at any time. Global variables should be set for the different strings. Then, you can get and set the values of each of them.</p>
<pre class="prettyprint">
var realtime_text;
var realtime_title;
function loaded_realtime(doc){
	realtime_doc = doc;
	realtime_text = doc.getModel().getRoot().get("text");
	realtime_title = doc.getModel().getRoot().get("title");
	
	realtime_text.setText("new text");
	console.log(realtime_text.getText());
	//will print: "new text"
}
</pre>	

	<h6>4. Add events</h6>
	<p>One of the great things about collaborative strings (and lists, etc.) is that they emit events whenever they are changed. The document itself also emits events when an error occurs, a user joins, or a user leaves. To add a listener to a collaborative element, simply use <code>addEventListener</code>.
	
<pre class="prettyprint">
function loaded_realtime(doc){
	realtime_doc = doc;
	realtime_text = doc.getModel().getRoot().get("text");
	realtime_title = doc.getModel().getRoot().get("title");
	
	realtime_text.addEventListener(gapi.drive.realtime.EventType.TEXT_INSERTED, onChange);
	realtime_text.addEventListener(gapi.drive.realtime.EventType.TEXT_DELETED, onChange);
	
	realtime_doc.addEventListener(gapi.drive.realtime.EventType.COLLABORATOR_LEFT, userLeft);
	realtime_doc.addEventListener(gapi.drive.realtime.EventType.COLLABORATOR_JOINED, userJoin);
	
}

function onChange(event){
	if(event.isLocal){
		//you made the change
	}
	else{
		//someone else made the change
	}
}

function userLeft(doc){
	var col = doc.collaborator; //the user who left
}

function userJoin(doc){
	var col = doc.collaborator; //the user who joined
}
</pre>

	<p>Note that the <code>doc</code> in <code>userLeft</code> and <code>userJoin</code> is different than that in <code>loaded_realtime</code>. If you need to get all of the active collaborators at any time, <code>realtime_doc</code> has a function for that. It will return a list of collaborators, each with its own color, name, session id (unique to every person online), and user id (unique to every Google account).</p>
	
<pre class="prettyprint">
function get_collab(){
	var cols = realtime_doc.getCollaborators();
	for(var i = 0; i &lt; cols.length; i++){
		if(cols[i].isMe){
			console.log("that's me!");
		}
	}
}
</pre>
	<h6><b>Final Javascript</b></h6>
<pre class="prettyprint">
var CLIENT_ID = "something";
var SCOPES = ['https://www.googleapis.com/auth/drive.install','https://www.googleapis.com/auth/drive'];
var file_id = "0ByWSHHBN-zyoRVN6UVlkYlp2dGM";

function loadDrive(){ //start here ***
	gapi.auth.authorize({'client_id': CLIENT_ID, 'scope': SCOPES.join(' '), 'immediate': true},handleAuth);
}
function handleAuth(authResult){
	if (authResult) {
		//logged in
		loadClient();
		
	} 
}

function loadClient() {
	gapi.load("auth:client,drive-realtime,drive-share", load_real);
}

function load_real(){
	init();
}

function init(){
	gapi.drive.realtime.load(file_id, loaded_realtime, init_realtime, errorFn);
}

function errorFn(error){

}
var realtime_doc;
var realtime_text;
var realtime_tite;

function init_realtime(model){
	model.getRoot().set("text", model.createString("default text"));
	//						constructor for collaborative string
	model.getRoot().set("text", model.createString("default title"));
}


function loaded_realtime(doc){
	realtime_doc = doc;
	realtime_text = doc.getModel().getRoot().get("text");
	realtime_title = doc.getModel().getRoot().get("title");
	
	realtime_text.addEventListener(gapi.drive.realtime.EventType.TEXT_INSERTED, onChange);
	realtime_text.addEventListener(gapi.drive.realtime.EventType.TEXT_DELETED, onChange);
	
	realtime_doc.addEventListener(gapi.drive.realtime.EventType.COLLABORATOR_LEFT, userLeft);
	realtime_doc.addEventListener(gapi.drive.realtime.EventType.COLLABORATOR_JOINED, userJoin);
	
}

function onChange(event){
	if(event.isLocal){
		//you made the change
	}
	else{
		//someone else made the change
	}
}

function userLeft(doc){
	var col = doc.collaborator; //the user who left
}

function userJoin(doc){
	var col = doc.collaborator; //the user who joined
}

function get_collab(){
	var cols = realtime_doc.getCollaborators();
	for(var i = 0; i &lt; cols.length; i++){
		if(cols[i].isMe){
			console.log("that's me!");
		}
	}
}
</pre>
    </div>

    <!-- Load JS here for greater good =============================-->
    <script src="../about/flat/js/jquery-ui-1.10.3.custom.min.js"></script>
    <script src="../about/flat/js/jquery.ui.touch-punch.min.js"></script>
    <script src="../about/flat/js/bootstrap.min.js"></script>
    <script src="../about/flat/js/bootstrap-select.js"></script>
    <script src="../about/flat/js/bootstrap-switch.js"></script>
    <script src="../about/flat/js/flatui-checkbox.js"></script>
    <script src="../about/flat/js/flatui-radio.js"></script>
    <script src="../about/flat/js/jquery.tagsinput.js"></script>
    <script src="../about/flat/js/jquery.placeholder.js"></script>
    
    <script src="https://codeyourcloud.com/lib/big-text/big-text.js"></script>
    
    <script src="lesson.js"></script>
    <link rel="stylesheet" href="lesson.css"/>
    
    <script>
    	function search(){
    		var query = $("#search_input").val().split("/").join("").split(" ").join("_");
	    	window.location.href = "https://codeyourcloud.com/lessons?search=" + query;
    	}
    	$("h1").bigtext();
    </script>
  </body>
</html>