<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Introduction to Websockets and Node.js</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="../about/flat/js/jquery-1.8.3.min.js"></script>

    <!-- Loading Bootstrap -->
    <link href="../about/flat/bootstrap/css/bootstrap.css" rel="stylesheet">

    <!-- Loading Flat UI -->
    <link href="../about/flat/css/flat-ui.css" rel="stylesheet">

    <link rel="shortcut icon" href="../favicon.ico">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements. All other JS at the end of file. -->
    <!--[if lt IE 9]>
      <script src="../about/flat/js/html5shiv.js"></script>
      <script src="../about/flat/js/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="lesson.css"/>
    <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js"></script>
    <link rel='stylesheet' type='text/css' href='../lib/Font/css/font-awesome.min.css'>
  </head>
  
  <body>
    <!-- /.container -->
    
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
	  <div class="container-fluid">
	    <!-- Brand and toggle get grouped for better mobile display -->
	    <div class="navbar-header">
	      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
	        <span class="sr-only">Toggle navigation</span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	      </button>
	      <a class="navbar-brand" href="https://codeyourcloud.com">Code Your Cloud</a>
	    </div>
	
	    <!-- Collect the nav links, forms, and other content for toggling -->
	    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
	      <ul class="nav navbar-nav">
	      	<li><a href="https://codeyourcloud.com/about">About</a></li>
	        <li><a href="https://codeyourcloud.com/lessons"><i class="fa fa-graduation-cap"></i> Lessons</a></li>
	        <div class="navbar-form navbar-left" role="search">
        		<div class="form-group">
          			<input type="text" class="form-control" placeholder="Search" id="search_input">
        		</div>
        		<button class="btn btn-default" onclick="search()"><i class="fa fa-search"></i></button>
      		</div>
      		</ul>
      	<ul class="nav navbar-nav navbar-right">
      		<li><a href="https://codeyourcloud.com/help"><i class="fa fa-life-ring"></i> Help</a></li>
      		<li><a href="https://codeyourcloud.com/about#contact"><i class="fa fa-comment-o"></i> Contact us</a></li>
      		<li id="github"><a href="https://github.com/mkaminsky11/codeyourcloud"><i class="fa fa-github-square"></i> Github</a></li>
	      </ul>
	    </div><!-- /.navbar-collapse -->
	  </div><!-- /.container-fluid -->
	</nav>
	
	
    <div id="main">
    	<h1>Introduction to Websockets and Node.js</h1>
    	<p>Websockets is a great way to communicate between client-side and server-side javascript, and can allow for client-to-client communication. Here, we will be setting up a basic chat application using Websockets and Node.js.</p>
    	<br/>
    	<h6><b>1. Getting dependencies</b></h6>
    	<p>First, we need to install node. Instructions on how to do this are also available <a href="http://howtonode.org/how-to-install-nodejs">here</a>.
    	<p><b>For Mac</b></p>
<pre>
git clone git://github.com/ry/node.git
cd node
./configure
make
sudo make install
</pre>
		<p><b>For Ubuntu</b></p>
<pre>
git clone git://github.com/ry/node.git
cd node
./configure
make
sudo make install
</pre>
		<p><b>For Windows</b></p>
<pre>
git clone git://github.com/ry/node.git
cd node
./configure
make
sudo make install
</pre>
		<small>Note: you may have to install <code>git</code> first.</small>
		<p>Then, we have to install the module for websockets. Navigate to the folder in which you want to host the websocket file and enter the following line.</p>
<pre>
npm install websocket	
</pre>
		<p>Next, we need to install Forever, which will keep the file running even after we close the session.</p>
<pre>
npm install forever
</pre>
		<p>To run a file using Forever, use <code>forever start test.js</code>. To restart, <code>forever restart test.js</code>. To stop, <code>forever stop test.js</code>. To list the running files, use <code>forever list</code>.</p>
		
		<h6><b>2. Set up the html</b></h6>
		<p>The HTML is fairly basic. The chat "bubbles" will just be <code>&lt;p&gt;</code>s.</p>
		<h6><b>Final html</b></h6>
<pre class="prettyprint">
&lt;!DOCTYPE html&gt;
	&lt;body&gt;
		&lt;div class="main"&gt;
			
		&lt;/div>
		&lt;textarea id="chat"&gt;&lt;/textarea&gt;
		&lt;script src="https://codeyourcloud.com/about/flat/js/jquery-1.8.3.min.js"&gt;&lt;/script&gt;
		&lt;script src="index.js"&gt;&lt;/script&gt;
		&lt;button onclick="sendChat()"&gt;&lt;/button&gt;
	&lt;/body&gt;
&lt;/html&gt;
</pre>
		<p>Then, create an empty file in the same folder called <code>index.js</code>. Also create file called <code>server.js</code>. Your project folder should look something like this.</p>
<pre>
project
|
|----index.js
|----index.html
|----server.js
|-----node_modules
	|------websocket
	|------forever
</pre>
		<h6><b>3. Client-side</b></h6>
		<p>Here, we're going to set up the client-side javascript. This is the <code>index.js</code> file. We need 2 functions. One, called <code>addChat()</code>, should add a chat bubble. The other, called <code>sendChat()</code>, should send your message to the server.</p>
		<h6><b>Final client-side</b></h6>
<pre class="prettyprint">
var connection = new WebSocket('ws://example.com:8080');
connection.onopen = function () {
	console.log("open");
};
connection.onmessage = function (message_json) {
	try {
		var json = JSON.parse(message_json.data);
		var type = json.type; //this is the type of data. Specificed by the server
		if(type === "new_chat"){
			//you got a new chat!
			var chat_message = json.message;
			addChat(message);
		}
	} catch (e) {
		return;
	}
};
function addChat(text){
	var bubble = "&lt;p&gt;" + text + "&lt;/p&gt;";
	$("#main").html($("#main").html() + bubble);
	//add an element
}
function sendChat(){
	var message = $("#chat").val().split("\n");
	$("#chat").val(""); //reset text area
	connection.send(JSON.stringify({type:"new_chat", message: message}));
	//end the message
}
connection.onerror = function (error) {
};
</pre>
		<p>The <code>ws://</code> prefix is used for connections note secured with SSL. <code>wss://</code> is used for secured connections (more on that later). Data is sent using a <code>JSON</code> object. A regular object can be turned in <code>JSON</code> using <code>JSON.stringify(object)</code>. It can then be convered back into a regular object by using <code>JSON.parse(message.data)</code>.</p>
		
		
		<h6><b>4. Server-side setup</b></h6>
		<p>First, we need to set up the basics of the websocket server.</p>
<pre class="prettyprint">
//=============================
"user strict";
process.title = 'example';
var webSocketsServerPort = 8080;
var webSocketServer = require('websocket').server;
var http = require('http');

var server = http.createServer(function(request, response) {
});
//==========================
server.listen(webSocketsServerPort, function() {
    
});

var wsServer = new webSocketServer({
    httpServer: server,
    autoAcceptConnections: false
});

var total = 0;


wsServer.on('request', function(request) {
	    var connection = request.accept(null, request.origin);
		connection.id = ++total;
	    connection.on('message', function(message) {
	        try{
	        	var json = JSON.parse(message.utf8Data);
	        	
		        	
			}
		    catch(e){
		    }
		 });
		
	    // user disconnected
	    connection.on('close', function(reasonCode, description){
	       
	    });
	 
	
});

</pre>
		<p>If you want to use SSL encryption, start the file like this:</p>
<pre class="prettyprint">
//========================
"user strict";
process.title = 'example';
var webSocketsServerPort = 8080;
var webSocketServer = require('websocket').server;
var https = require('https');

var options = {
	key: fs.readFileSync("key.pem"),
	cert: fs.readFileSync("cert.pem"),
	ca: [fs.readFileSync("ca.pem")]
};

var server = https.createServer(options, function(req, res){
});
//========================================
</pre>
		<p>Next, we need to store <b>all</b> of the clients so that we can broadcast infromation to them. Also, we need to detect new chat messages.</p>
<pre class="prettyprint">
//=============================
"user strict";
process.title = 'example';
var webSocketsServerPort = 8080;
var webSocketServer = require('websocket').server;
var http = require('http');

var server = http.createServer(function(request, response) {
});
//==========================
server.listen(webSocketsServerPort, function() {
    
});

var wsServer = new webSocketServer({
    httpServer: server,
    autoAcceptConnections: false
});

var total = 0;
var users = [];

wsServer.on('request', function(request) {
	    var connection = request.accept(null, request.origin);
		connection.id = ++total;
		users.push[connection];
	    connection.on('message', function(message) {
	        try{
	        	var json = JSON.parse(message.utf8Data);
	        	if(json.type === "new_chat"){
	        		var text = json.message;
	        		//have to broadcast it
	        	}
		        	
			}
		    catch(e){
		    }
		 });
		
	    // user disconnected
	    connection.on('close', function(reasonCode, description){
	       for(var i = 0; i < users.length;i++){
	       		if(users[i].id === connection.id){
	       			users.splice(i,1);
	       			//remove the disconnected user
	       		}
	       }
	    });
	 
	
});
</pre>
		<p>Here, you can see that all of the users are stored in the array <code>users</code>. If a user disconnects, he is removed from the array. All what's left is broadcasting the new information to all of the users.</p>
		
		<br/>
		<h6><b>Final server-side</b></h6>
<pre class="prettyprint">
//=============================
"user strict";
process.title = 'example';
var webSocketsServerPort = 8080;
var webSocketServer = require('websocket').server;
var http = require('http');

var server = http.createServer(function(request, response) {
});
//==========================
server.listen(webSocketsServerPort, function() {
    
});

var wsServer = new webSocketServer({
    httpServer: server,
    autoAcceptConnections: false
});

var total = 0;
var users = [];

wsServer.on('request', function(request) {
	    var connection = request.accept(null, request.origin);
		connection.id = ++total;
		users.push[connection];
	    connection.on('message', function(message) {
	        try{
	        	var json = JSON.parse(message.utf8Data);
	        	if(json.type === "new_chat"){
	        		var text = json.message;
	        		//have to broadcast it
	        		for(var i = 0; i < users.length; i++){
	        			users[i].send(JSON.stringify({type:"new_chat", message: text}));
	        		}
	        	}
		        	
			}
		    catch(e){
		    }
		 });
		
	    // user disconnected
	    connection.on('close', function(reasonCode, description){
	       for(var i = 0; i < users.length;i++){
	       		if(users[i].id === connection.id){
	       			users.splice(i,1);
	       			//remove the disconnected user
	       		}
	       }
	    });
	 
	
});
</pre>
    </div>
    <!-- Load JS here for greater good =============================-->
    <script src="../about/flat/js/jquery-ui-1.10.3.custom.min.js"></script>
    <script src="../about/flat/js/jquery.ui.touch-punch.min.js"></script>
    <script src="../about/flat/js/bootstrap.min.js"></script>
    <script src="../about/flat/js/bootstrap-select.js"></script>
    <script src="../about/flat/js/bootstrap-switch.js"></script>
    <script src="../about/flat/js/flatui-checkbox.js"></script>
    <script src="../about/flat/js/flatui-radio.js"></script>
    <script src="../about/flat/js/jquery.tagsinput.js"></script>
    <script src="../about/flat/js/jquery.placeholder.js"></script>
    
    <script src="https://codeyourcloud.com/lib/big-text/big-text.js"></script>
    <script src="lesson.js"></script>
    <link rel="stylesheet" href="lesson.css"/>
    
    <script>
    	function search(){
    		var query = $("#search_input").val().split("/").join("").split(" ").join("_");
	    	window.location.href = "https://codeyourcloud.com/lessons?search=" + query;
    	}
    	$("h1").bigtext();
    </script>
  </body>
</html>